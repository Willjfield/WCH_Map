<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>ArcGIS API for JavaScript Tutorials: Display a map</title>

    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.0/axios.js"
        integrity="sha512-MNW6IbpNuZZ2VH9ngFhzh6cUt8L/0rSVa60F8L22K1H72ro4Ki3M/816eSDLnhICu7vwH/+/yb8oB3BtBLhMsA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://js.arcgis.com/4.22/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.22/"></script>
    <script>
        require(["esri/config", "esri/Map", "esri/views/MapView",
            "esri/layers/support/LabelClass", "esri/layers/GeoJSONLayer",
            "esri/symbols/SimpleFillSymbol", "esri/renderers/SimpleRenderer",
            "esri/Graphic", "esri/layers/GraphicsLayer"],
            function (esriConfig, Map, MapView, LabelClass, GeoJSONLayer, SimpleFillSymbol, SimpleRenderer, Graphic, GraphicsLayer) {

                esriConfig.apiKey = "AAPK34aa95241bd14d65a190aad6a5423795BeuJfE_PQFJLJTLbZZLn2lQA4TgiQqodhptr-I_oh8Lp23QZpDY4ziQdVtt5XyVa";

                const map = new Map({
                    basemap: "streets" // Basemap layer service
                });

                const view = new MapView({
                    map: map,
                    center: [0, 0], // Longitude, latitude
                    zoom: 3, // Zoom level
                    container: "viewDiv" // Div element
                });

                const nativeLandAPI = 'https://native-land.ca/wp-json/nativeland/v1/api/index.php?maps=territories';
                const landLabelClass = new LabelClass({
                    labelExpressionInfo: { expression: "$feature.slug" },
                    symbol: {
                        "font": {
                            "style": "normal",

                        },
                        type: "text",  // autocasts as new TextSymbol()
                        color: "black",
                        haloSize: 1,
                        haloColor: "white"
                    }
                });

                axios({
                    method: "GET",
                    url: "https://api.baserow.io/api/database/rows/table/50209/?user_field_names=true",
                    headers: {
                        Authorization: "Token loPSf2BpL784tYF2sv0j8KvevdK0Jtmt"
                    }
                }).then((resp) => {
                    const lnglats = resp.data.results.map((l) => l.test.split(','));
                    const graphicsLayer = new GraphicsLayer();
                    map.add(graphicsLayer);
                    lnglats.forEach(lnglat => {

                        const point = { //Create a point
                            type: "point",
                            longitude: lnglat[0],
                            latitude: lnglat[1]
                        };

                        const simpleMarkerSymbol = {
                            type: "simple-marker",
                            color: [226, 119, 40],  // Orange
                            outline: {
                                color: [255, 255, 255], // White
                                width: 1
                            }
                        };

                        const pointGraphic = new Graphic({
                            geometry: point,
                            symbol: simpleMarkerSymbol
                        });
                        graphicsLayer.add(pointGraphic);
                    });

                })
                axios.get(nativeLandAPI).then((resp) => {

                    const geojson = {
                        type: "FeatureCollection",
                        features: resp.data
                    };

                    const blob = new Blob([JSON.stringify(geojson)], {
                        type: "application/json"
                    });
                    const url = URL.createObjectURL(blob);
                    const layer = new GeoJSONLayer({
                        url,
                        labelsVisible: true,
                        labelingInfo: [landLabelClass],
                        renderer: new SimpleRenderer({
                            symbol: new SimpleFillSymbol({
                                color: "rgba(0,76,115,0.4)",
                                outline: null
                            })
                        })
                    });

                    map.add(layer)
                })
            });
    </script>

</head>

<body>
    <div id="viewDiv"></div>
</body>

</html>